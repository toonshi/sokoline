{% extends 'base.html' %}

{% block content %}
  <h2>{{ user.business_name }}</h2>
  <p><strong>Username:</strong> {{ user.username }}</p>
  <p><strong>Phone:</strong> {{ user.phone_number }}</p>
  <p><strong>Bio:</strong> {{ user.bio }}</p>

  <p><a href="{% url 'product_create' %}">Add New Product</a></p>

  <h3>Your Products</h3>
  {% for product in user.products.all %}
    <div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px;">
      <h4><a href="{{ product.get_absolute_url }}">{{ product.name }}</a></h4>
      <p>Price: KES {{ product.price }}</p>
      <button onclick="copyPurchaseLink(this, {{ product.pk }})">Get Link</button>
    </div>
  {% empty %}
    <p>You have no products yet.</p>
  {% endfor %}

  <script>
    function copyPurchaseLink(button, productId) {
      // Construct the absolute URL for the purchase link
      const purchaseUrl = `{{ request.scheme }}://{{ request.get_host }}{% url 'product_purchase' pk=0 %}`.replace('0', productId);

      // Use the modern Clipboard API
      navigator.clipboard.writeText(purchaseUrl).then(function() {
        // Success feedback
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.disabled = true;
        setTimeout(function() {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000); // Revert back after 2 seconds
      }, function(err) {
        // Error fallback (e.g., for older browsers or if permissions are denied)
        console.error('Could not copy text: ', err);
        // Fallback to the old prompt method if clipboard fails
        window.prompt("Could not copy automatically. Please copy this link:", purchaseUrl);
      });
    }
  </script>
{% endblock %}
