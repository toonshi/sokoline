{% extends 'base.html' %}

{% block content %}
  <h2>{{ product.name }}</h2>
  <p><strong>Seller:</strong> {{ product.owner.business_name }}</p>
  <p><strong>Price:</strong> KES {{ product.price }}</p>
  <p>{{ product.description }}</p>

  <h3>Buy Now with M-Pesa</h3>
  <form id="mpesaPaymentForm">
    {% csrf_token %}
    <label for="phoneNumber">Phone Number (e.g., 0712345678):</label><br>
    <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="e.g., 0712345678" required><br><br>
    <button type="submit">Pay KES {{ product.price }}</button>
  </form>

  <p id="paymentMessage"></p>

  <script>
    document.getElementById('mpesaPaymentForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const phoneNumber = document.getElementById('phoneNumber').value;
      const productId = {{ product.pk }};
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const paymentMessage = document.getElementById('paymentMessage');

      paymentMessage.textContent = 'Initiating M-Pesa STK Push... Check your phone.';
      paymentMessage.style.color = 'blue';

      fetch('{% url "initiate_payment" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          product_id: productId,
          phone_number: phoneNumber
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          paymentMessage.textContent = 'STK Push initiated successfully! Check your phone for the M-Pesa prompt.';
          paymentMessage.style.color = 'green';
        } else {
          paymentMessage.textContent = 'Payment initiation failed: ' + (data.message || 'Unknown error.');
          paymentMessage.style.color = 'red';
        }
      })
      .catch(error => {
        paymentMessage.textContent = 'An error occurred: ' + error.message;
        paymentMessage.style.color = 'red';
        console.error('Error:', error);
      });
    });
  </script>
{% endblock %}
