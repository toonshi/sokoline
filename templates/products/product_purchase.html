{% extends 'base.html' %}

{% block content %}
  <div style="max-width: 600px; margin: auto; padding: 20px; text-align: center;">
    <h2>Direct Purchase</h2>
    <p>You are about to purchase the following item:</p>
    
    <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; margin-top: 20px;">
        <h3>{{ product.name }}</h3>
        <p><strong>Sold by:</strong> {{ product.owner.business_name|default:product.owner.username }}</p>
        <p><strong>Price:</strong> KES {{ product.price }}</p>
    </div>

    <div style="margin-top: 30px;">
        <h3>Pay with M-Pesa</h3>
        <form id="mpesaPaymentForm">
            {% csrf_token %}
            <label for="phoneNumber">Enter your M-Pesa phone number to pay:</label><br>
            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="e.g., 0712345678" required style="padding: 8px; margin-top: 10px; width: 80%;"><br><br>
            <button type="submit" style="padding: 10px 20px; font-size: 16px;">Pay KES {{ product.price }}</button>
        </form>
        <p id="paymentMessage" style="margin-top: 15px; font-weight: bold;"></p>
    </div>
  </div>

  <script>
    document.getElementById('mpesaPaymentForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const phoneNumber = document.getElementById('phoneNumber').value;
      const productId = {{ product.pk }};
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const paymentMessage = document.getElementById('paymentMessage');

      paymentMessage.textContent = 'Initiating M-Pesa STK Push...';
      paymentMessage.style.color = 'blue';

      fetch('{% url "initiate_payment" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          product_id: productId,
          phone_number: phoneNumber
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          paymentMessage.textContent = 'STK Push sent successfully! Please check your phone and enter your M-Pesa PIN to complete the payment.';
          paymentMessage.style.color = 'green';
        } else {
          paymentMessage.textContent = 'Payment initiation failed: ' + (data.message || 'Unknown error.');
          paymentMessage.style.color = 'red';
        }
      })
      .catch(error => {
        paymentMessage.textContent = 'An error occurred: ' + error.message;
        paymentMessage.style.color = 'red';
        console.error('Error:', error);
      });
    });
  </script>
{% endblock %}
